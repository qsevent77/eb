<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>销售数据分析报告（支持 Excel 上传）</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- SheetJS for Excel parsing -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --brand-1: #2f7ed8;
      --brand-2: #0d9488;
      --brand-3: #f59e0b;
      --brand-4: #ef4444;
      --muted: #6b7280;
      --card-bg: #ffffff;
    }
    body{ background: #f3f4f6; color: #111827; }
    .hero{ background: linear-gradient(90deg, rgba(47,126,216,0.08), rgba(13,148,136,0.04)); padding: 2rem; border-radius: .75rem; margin-bottom: 1rem; }
    .kpi { text-align: center; padding: 1rem; border-radius: .5rem; background: var(--card-bg); box-shadow: 0 1px 3px rgba(15,23,42,0.04); }
    .kpi h3{ margin:0; font-size:1.05rem; color:var(--muted); }
    .kpi p{ font-weight:700; font-size:1.5rem; margin: .25rem 0 0; }
    .section-card{ padding: 1rem; background: var(--card-bg); border-radius: .5rem; margin-bottom: 1rem; box-shadow: 0 1px 3px rgba(15,23,42,0.04); }
    .nav-link.active{ font-weight:600; }
    .small-muted{ color:var(--muted); font-size:0.9rem; }
    footer{ opacity: .7; font-size: .85rem; padding: 1rem 0; text-align:center; }
    .chart-wrap{ position: relative; height:320px; }
    pre.debug{ background:#0b1220; color:#e6f0ff; padding: .5rem; border-radius: .25rem; overflow:auto; }
  </style>
</head>
<body>
  <div class="container py-4">
    <header class="d-flex flex-wrap align-items-center justify-content-between mb-3">
      <div>
        <h1 class="mb-0">销售数据分析报告</h1>
        <div class="small-muted">支持 Excel (.xlsx/.xls) 上传 · Chart.js · Bootstrap</div>
      </div>
      <div class="text-end">
        <label class="btn btn-outline-primary me-2">
          上传 Excel / CSV
          <input id="fileInput" type="file" accept=".xlsx,.xls,.csv" hidden>
        </label>
        <button id="useSample" class="btn btn-secondary">使用示例数据</button>
      </div>
    </header>

    <div class="row">
      <div class="col-12 hero section-card mb-3">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h2 id="reportTitle">总体销售概览</h2>
            <p class="small-muted" id="reportSubtitle">上传 Excel 或 CSV 后自动生成报告。</p>
          </div>
          <div style="min-width:280px;">
            <div class="d-flex gap-2">
              <div class="kpi flex-fill">
                <h3>总营收</h3>
                <p id="kpi_total_revenue">-</p>
              </div>
              <div class="kpi flex-fill">
                <h3>订单数</h3>
                <p id="kpi_orders">-</p>
              </div>
              <div class="kpi flex-fill">
                <h3>平均客单</h3>
                <p id="kpi_avg_order">-</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Navigation -->
    <nav class="mb-3">
      <div class="nav nav-pills">
        <a class="nav-link active" data-bs-toggle="pill" href="#summaryTab">执行摘要</a>
        <a class="nav-link" data-bs-toggle="pill" href="#kpiTab">关键指标</a>
        <a class="nav-link" data-bs-toggle="pill" href="#provinceTab">省份业绩</a>
        <a class="nav-link" data-bs-toggle="pill" href="#bigProductTab">大产品线</a>
        <a class="nav-link" data-bs-toggle="pill" href="#smallProductTab">小产品线</a>
        <a class="nav-link" data-bs-toggle="pill" href="#competitorTab">竞品分析</a>
        <a class="nav-link" data-bs-toggle="pill" href="#trendTab">趋势分析</a>
        <a class="nav-link" data-bs-toggle="pill" href="#recommendTab">建议与结论</a>
      </div>
    </nav>

    <div class="tab-content mb-5">
      <!-- Summary -->
      <div class="tab-pane fade show active" id="summaryTab">
        <div class="section-card">
          <h4>执行摘要</h4>
          <div id="executive_summary" class="mb-3 small-muted">请上传 Excel/CSV 数据以生成自动摘要。</div>
          <div id="auto_insights"></div>
        </div>
      </div>

      <!-- KPI -->
      <div class="tab-pane fade" id="kpiTab">
        <div class="section-card">
          <h4>关键指标展示</h4>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <h6>营收分布（按省份）</h6>
                <div class="chart-wrap"><canvas id="chart_province_revenue"></canvas></div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <h6>产品线占比（大产品线）</h6>
                <div class="chart-wrap"><canvas id="chart_big_product_share"></canvas></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Province -->
      <div class="tab-pane fade" id="provinceTab">
        <div class="section-card">
          <h4>省份业绩分析</h4>
          <p class="small-muted">按省份汇总营收与订单情况、Top5 省份细节、以及省际增长趋势。</p>
          <div class="mb-3">
            <h6>省份营收排名（柱状图）</h6>
            <div class="chart-wrap"><canvas id="chart_province_bar"></canvas></div>
          </div>
          <div id="province_details" class="mt-3"></div>
        </div>
      </div>

      <!-- Big Product -->
      <div class="tab-pane fade" id="bigProductTab">
        <div class="section-card">
          <h4>大产品线业绩分析</h4>
          <p class="small-muted">按大产品线汇总营收、占比与趋势。</p>
          <div class="mb-3">
            <h6>大产品线营收（饼图）</h6>
            <div class="chart-wrap"><canvas id="chart_big_product_pie"></canvas></div>
          </div>
          <div id="big_product_table" class="mt-3"></div>
        </div>
      </div>

      <!-- Small Product -->
      <div class="tab-pane fade" id="smallProductTab">
        <div class="section-card">
          <h4>小产品线业绩分析</h4>
          <div class="mb-3">
            <h6>小产品线 Top10（柱状图）</h6>
            <div class="chart-wrap"><canvas id="chart_small_product_bar"></canvas></div>
          </div>
        </div>
      </div>

      <!-- Competitor -->
      <div class="tab-pane fade" id="competitorTab">
        <div class="section-card">
          <h4>竞品分析（我司 / 联奕科技 / 正方软件）</h4>
          <p class="small-muted">如果存在 competitor 列，自动汇总各竞品营收、市场份额与趋势。</p>
          <div class="mb-3">
            <h6>竞品市场份额（圆环图）</h6>
            <div class="chart-wrap"><canvas id="chart_competitor_share"></canvas></div>
          </div>
          <div id="competitor_detail"></div>
        </div>
      </div>

      <!-- Trend -->
      <div class="tab-pane fade" id="trendTab">
        <div class="section-card">
          <h4>趋势分析</h4>
          <p class="small-muted">时间序列趋势（按月），以及同比 / 环比（若历史数据充足）。</p>
          <div class="mb-3">
            <h6>营收时间序列</h6>
            <div class="chart-wrap"><canvas id="chart_revenue_trend"></canvas></div>
          </div>
        </div>
      </div>

      <!-- Recommendation -->
      <div class="tab-pane fade" id="recommendTab">
        <div class="section-card">
          <h4>建议与结论</h4>
          <div id="recommendations" class="small-muted"></div>
        </div>
      </div>
    </div>

    <footer>
      模板由自动化分析引擎生成 — 适用于管理层汇报。如需定制请提供示例数据与具体规则。
    </footer>
  </div>

  <!-- Bootstrap bundle JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  // ========== Utilities ==========
  function fmtMoney(v){
    if (v == null || isNaN(v)) return '-';
    return (Number(v)).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
  }
  function safeNumber(v){
    if (v === null || v === undefined || v === '') return NaN;
    let n = Number(String(v).replace(/[,￥¥]/g,''));
    return isNaN(n) ? NaN : n;
  }

  const palette = ['#2f7ed8','#0d9488','#f59e0b','#ef4444','#7c3aed','#06b6d4','#f97316','#10b981','#ef6b8c'];
  const CHARTS = {};
  function destroyChart(id){ if (CHARTS[id]) { try{ CHARTS[id].destroy(); } catch(e){} delete CHARTS[id]; } }

  // ========== File handling (Excel/CSV) ========== 
  // ---------- Excel日期序列号转换 ----------
  function excelDateToJSDate(excelDate){
    return new Date(Math.round((excelDate - 25569) * 86400 * 1000));
  }

  function parseDateField(value){
    if(!value && value!==0) return null;
    if(!isNaN(value)){
      const jsDate = excelDateToJSDate(Number(value));
      return jsDate;
    }
    const jsDate = new Date(String(value).replace(/\./g,'-').replace(/\//g,'-'));
    return isNaN(jsDate)?null:jsDate;
  }

  // ---------- 上传处理 ----------
  
  document.getElementById('fileInput').addEventListener('change', async function(e){
    const f = e.target.files[0];
    if (!f) return;
    const name = f.name || '上传数据';
    const ext = name.split('.').pop().toLowerCase();
    if (ext === 'csv') {
      const text = await f.text();
      parseCSVText(text, name);
    } else {
      // read binary and parse with XLSX
      const data = await f.arrayBuffer();
      const wb = XLSX.read(data, { type: 'array' });
      const firstSheetName = wb.SheetNames[0];
      const worksheet = wb.Sheets[firstSheetName];
      const json = XLSX.utils.sheet_to_json(worksheet, { defval: '' });
      processData(json, name);
    }
  });

  // optional: parse CSV text if user uploads csv
  function parseCSVText(text, name){
    // simple CSV parse: split lines, header by first line, naive splitting by comma (acceptable for simple tests)
    // For robust CSV with commas in fields, swap to a proper CSV parser library.
    const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
    if (lines.length < 2) { alert('CSV 内容不足'); return; }
    const headers = lines[0].split(',');
    const rows = lines.slice(1).map(line => {
      const vals = line.split(',');
      const obj = {};
      headers.forEach((h,i)=> obj[h.trim()] = vals[i] !== undefined ? vals[i].trim() : '');
      return obj;
    });
    processData(rows, name);
  }

  // sample data button
  document.getElementById('useSample').addEventListener('click', function(){
    const sample = [
      {date:'2025-01-12',province:'上海',big_product:'教育云',small_product:'智慧课堂',competitor:'我司',school:'复旦大学',order_count:3,amount:72000},
      {date:'2025-02-03',province:'广东',big_product:'教学工具',small_product:'在线测评',competitor:'正方软件',school:'华南理工大学',order_count:1,amount:15000},
      {date:'2025-03-21',province:'北京',big_product:'教育云',small_product:'资源平台',competitor:'联奕科技',school:'中国传媒大学',order_count:2,amount:38000},
      {date:'2025-04-15',province:'江苏',big_product:'教学工具',small_product:'课程中心',competitor:'我司',school:'苏州大学',order_count:4,amount:54000},
      {date:'2025-05-07',province:'浙江',big_product:'办公应用',small_product:'协同办公',competitor:'联奕科技',school:'宁波大学',order_count:2,amount:18000},
      {date:'2025-05-28',province:'四川',big_product:'教育云',small_product:'智慧课堂',competitor:'正方软件',school:'电子科技大学',order_count:3,amount:45000},
      {date:'2025-06-19',province:'湖北',big_product:'教学工具',small_product:'课程中心',competitor:'我司',school:'武汉大学',order_count:5,amount:60000},
      {date:'2025-07-02',province:'辽宁',big_product:'办公应用',small_product:'文档管理',competitor:'联奕科技',school:'大连理工大学',order_count:1,amount:10000},
      {date:'2025-08-11',province:'陕西',big_product:'教育云',small_product:'资源平台',competitor:'我司',school:'西安交通大学',order_count:4,amount:92000},
      {date:'2025-09-05',province:'湖南',big_product:'教学工具',small_product:'在线测评',competitor:'正方软件',school:'湖南大学',order_count:2,amount:26000}
    ];
    processData(sample, '示例数据 (Excel 模式)');
  });

  // ========== Main processing ==========
  function processData(rows, sourceName){
    console.log('Loaded rows:', rows.length);
    document.getElementById('reportSubtitle').textContent = `数据来源：${sourceName} · ${rows.length} 条记录（自动分析）`;

    const headerSet = new Set(Object.keys(rows[0] || {}));
    function findCol(candidates){
      for (let c of candidates){
        for (let h of headerSet){
          if (h.toLowerCase().trim() === c.toLowerCase()) return h;
        }
      }
      for (let c of candidates){
        for (let h of headerSet){
          if (h.toLowerCase().includes(c.toLowerCase())) return h;
        }
      }
      return null;
    }

    const col_date = findCol(['date','ds','时间','交易时间']);
    const col_province = findCol(['province','prov','省','省份']);
    const col_big = findCol(['big_product','big product','大产品','大类','big']);
    const col_small = findCol(['small_product','small product','小产品','小类','small']);
    const col_comp = findCol(['competitor','company','竞品','vendor']);
    const col_school = findCol(['school','institution','学校']);
    const col_order = findCol(['order_count','orders','订单','order']);
    const col_amount = findCol(['amount','revenue','sales','金额','money']);
    const amountCol = col_amount;

    console.log('Inferred columns:', {col_date,col_province,col_big,col_small,col_comp,col_school,col_order,amountCol});

    const parsedRows = rows.map(r=>{
      return {
        raw: r,
        date: col_date && r[col_date] ? parseDateField(r[col_date]) : null,
        province: col_province ? (r[col_province] || '未知') : '未知',
        big: col_big ? (r[col_big] || '未知') : '未知',
        small: col_small ? (r[col_small] || '未知') : '未知',
        competitor: col_comp ? (r[col_comp] || '我司') : (r['competitor'] || '我司'),
        school: col_school ? (r[col_school] || '') : '',
        orders: col_order ? safeNumber(r[col_order]) : safeNumber(r['order_count']) || 1,
        amount: amountCol ? safeNumber(r[amountCol]) : NaN
      };
    });

    const validAmountRows = parsedRows.filter(r => !isNaN(r.amount));
    const totalRevenue = validAmountRows.reduce((s,r)=> s + (r.amount||0), 0);
    const totalOrders = parsedRows.reduce((s,r)=> s + (isNaN(r.orders) ? 0 : r.orders), 0);
    const avgOrder = totalOrders > 0 ? totalRevenue / totalOrders : (validAmountRows.length>0 ? totalRevenue/validAmountRows.length : 0);

    document.getElementById('kpi_total_revenue').textContent = '¥' + fmtMoney(totalRevenue);
    document.getElementById('kpi_orders').textContent = (isNaN(totalOrders) ? '-' : totalOrders);
    document.getElementById('kpi_avg_order').textContent = '¥' + fmtMoney(avgOrder);

    function aggBy(key){
      const map = new Map();
      for (let r of parsedRows){
        const k = r[key] || '未知';
        if (!map.has(k)) map.set(k, {key:k, revenue:0, orders:0, count:0});
        const rec = map.get(k);
        rec.revenue += (isNaN(r.amount)?0:r.amount);
        rec.orders += (isNaN(r.orders)?0:r.orders);
        rec.count += 1;
      }
      return Array.from(map.values()).sort((a,b)=>b.revenue - a.revenue);
    }

    const byProvince = aggBy('province');
    const byBig = aggBy('big');
    const bySmall = aggBy('small');
    const byComp = aggBy('competitor');

    // time series aggregation by month
    const timeMap = new Map();
    for (let r of parsedRows){
      const d = r.date instanceof Date && !isNaN(r.date) ? r.date : null;
      const key = d ? `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}` : '未知';
      if (!timeMap.has(key)) timeMap.set(key, {key, revenue:0, orders:0});
      timeMap.get(key).revenue += (isNaN(r.amount)?0:r.amount);
      timeMap.get(key).orders += (isNaN(r.orders)?0:r.orders);
    }
    const times = Array.from(timeMap.values()).sort((a,b)=> a.key.localeCompare(b.key));

    // render charts & tables
    renderProvinceRevenueChart(byProvince);
    renderBigProductShareChart(byBig);
    renderProvinceBar(byProvince);
    renderBigProductPie(byBig);
    renderSmallProductBar(bySmall.slice(0,10));
    renderCompetitorShare(byComp);
    renderRevenueTrend(times);

    renderProvinceDetails(byProvince);
    renderBigProductTable(byBig);
    renderCompetitorDetail(byComp);

    // insights & recs
    const topProvince = byProvince[0];
    const topBig = byBig[0];
    const topSmall = bySmall[0];
    const topComp = byComp[0];

    const insights = [];
    insights.push(`<p>数据来源：<strong>${sourceName}</strong>；记录数：${rows.length} 条。</p>`);
    if (topProvince) insights.push(`<p>最高营收省份：<strong>${topProvince.key}</strong>，营收 ¥${fmtMoney(topProvince.revenue)}。</p>`);
    if (topBig) insights.push(`<p>大产品线领跑：<strong>${topBig.key}</strong>，营收 ¥${fmtMoney(topBig.revenue)}。</p>`);
    if (topSmall) insights.push(`<p>小产品线 Top：<strong>${topSmall.key}</strong>，营收 ¥${fmtMoney(topSmall.revenue)}。</p>`);
    if (topComp) insights.push(`<p>竞品中营收最高：<strong>${topComp.key}</strong>（¥${fmtMoney(topComp.revenue)}）。</p>`);

    if (times.length >= 2){
      const first = times[0].revenue;
      const last = times[times.length-1].revenue;
      const pct = first>0 ? ((last-first)/first*100) : 0;
      insights.push(`<p>时间序列（${times[0].key} → ${times[times.length-1].key}）：营收从 ¥${fmtMoney(first)} 变至 ¥${fmtMoney(last)}，变化 ${pct.toFixed(1)}%。</p>`);
    }

    const recs = [];
    if (topProvince && topProvince.revenue/totalRevenue > 0.4){
      recs.push(`<li>省份集中度较高（${topProvince.key} 占比较大），建议分散风险或将成功经验复制至其他省份。</li>`);
    } else {
      recs.push(`<li>省际分布较均衡，保持区域策略并在表现好省份加大投入。</li>`);
    }
    if (topBig && topBig.revenue/totalRevenue < 0.2) {
      recs.push(`<li>产品组合多元，建议向高毛利/高增长产品倾斜资源。</li>`);
    } else {
      recs.push(`<li>主力产品线 ${topBig.key} 表现突出，建议持续强化该产品线。</li>`);
    }
    recs.push(`<li>竞品对比：根据竞品强势地区考虑促销/高校合作等策略以争取市场份额。</li>`);

    document.getElementById('auto_insights').innerHTML = insights.join('');
    document.getElementById('recommendations').innerHTML = `<ul>${recs.join('')}</ul>`;
  }

  // flex-date parser: try common formats
  function parseDateFlex(v){
    if (!v && v !== 0) return null;
    if (v instanceof Date) return v;
    // Excel numeric date (JS number) might come as number string: Excel serial -> convert if reasonable
    if (!isNaN(v) && v > 1000) {
      // treat as yyyyMMdd maybe — not safe; try as Number then toString
      const s = String(v);
      if (/^\d{8}$/.test(s)) {
        const y = s.slice(0,4), m = s.slice(4,6)-1, d = s.slice(6,8);
        return new Date(y, m, d);
      }
    }
    // Try Date constructor or replace - . /
    const normalized = String(v).replace(/\./g,'-').replace(/\//g,'-').replace(/\s+/g,' ').trim();
    const d = new Date(normalized);
    if (!isNaN(d)) return d;
    // fallback null
    return null;
  }

  // ========== Charts ==========
  function renderProvinceRevenueChart(byProvince){
    const labels = byProvince.map(r=>r.key);
    const data = byProvince.map(r=>r.revenue);
    destroyChart('chart_province_revenue');
    const ctx = document.getElementById('chart_province_revenue').getContext('2d');
    CHARTS['chart_province_revenue'] = new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label: '营收 (¥)', data, backgroundColor: palette }]},
      options: { plugins:{ legend:{ display:false }}, responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } } }
    });
  }

  function renderBigProductShareChart(byBig){
    const labels = byBig.map(r=>r.key);
    const data = byBig.map(r=>r.revenue);
    destroyChart('chart_big_product_share');
    const ctx = document.getElementById('chart_big_product_share').getContext('2d');
    CHARTS['chart_big_product_share'] = new Chart(ctx, {
      type: 'doughnut',
      data: { labels, datasets: [{ data, backgroundColor: palette }] },
      options: { plugins:{ legend:{ position:'right' }}, responsive:true, maintainAspectRatio:false }
    });
  }

  function renderProvinceBar(byProvince){
    const labels = byProvince.map(r=>r.key);
    const data = byProvince.map(r=>r.revenue);
    destroyChart('chart_province_bar');
    const ctx = document.getElementById('chart_province_bar').getContext('2d');
    CHARTS['chart_province_bar'] = new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label:'营收 (¥)', data, backgroundColor: palette }]},
      options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } } }
    });
  }

  function renderBigProductPie(byBig){
    const labels = byBig.map(r=>r.key);
    const data = byBig.map(r=>r.revenue);
    destroyChart('chart_big_product_pie');
    const ctx = document.getElementById('chart_big_product_pie').getContext('2d');
    CHARTS['chart_big_product_pie'] = new Chart(ctx, {
      type: 'pie',
      data: { labels, datasets: [{ data, backgroundColor: palette }] },
      options: { responsive:true, maintainAspectRatio:false }
    });
  }

  function renderSmallProductBar(bySmallTop){
    const labels = bySmallTop.map(r=>r.key);
    const data = bySmallTop.map(r=>r.revenue);
    destroyChart('chart_small_product_bar');
    const ctx = document.getElementById('chart_small_product_bar').getContext('2d');
    CHARTS['chart_small_product_bar'] = new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label:'营收 (¥)', data, backgroundColor: palette }]},
      options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } } }
    });
  }

  function renderCompetitorShare(byComp){
    const labels = byComp.map(r=>r.key);
    const data = byComp.map(r=>r.revenue);
    destroyChart('chart_competitor_share');
    const ctx = document.getElementById('chart_competitor_share').getContext('2d');
    CHARTS['chart_competitor_share'] = new Chart(ctx, {
      type: 'doughnut',
      data: { labels, datasets: [{ data, backgroundColor: palette }]},
      options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'right'}}}
    });
  }

  function renderRevenueTrend(times){
    const labels = times.map(t=>t.key);
    const data = times.map(t=>t.revenue);
    destroyChart('chart_revenue_trend');
    const ctx = document.getElementById('chart_revenue_trend').getContext('2d');
    CHARTS['chart_revenue_trend'] = new Chart(ctx, {
      type: 'line',
      data: { labels, datasets: [{ label:'营收 (¥)', data, tension:0.3, fill:true, backgroundColor: 'rgba(47,126,216,0.08)', borderColor: palette[0] }]},
      options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } } }
    });
  }

  // ========== Details ==========
  function renderProvinceDetails(byProvince){
    const cont = document.getElementById('province_details');
    const top5 = byProvince.slice(0,5);
    let html = `<h6>Top5 省份明细</h6><div class="table-responsive"><table class="table table-sm"><thead><tr><th>省份</th><th>营收 (¥)</th><th>订单数</th><th>记录数</th></tr></thead><tbody>`;
    for (let r of top5){
      html += `<tr><td>${r.key}</td><td>¥${fmtMoney(r.revenue)}</td><td>${r.orders}</td><td>${r.count}</td></tr>`;
    }
    html += `</tbody></table></div>`;
    cont.innerHTML = html;
  }

  function renderBigProductTable(byBig){
    const cont = document.getElementById('big_product_table');
    let html = `<div class="table-responsive"><table class="table table-sm"><thead><tr><th>大产品线</th><th>营收 (¥)</th><th>订单数</th><th>记录数</th></tr></thead><tbody>`;
    for (let r of byBig){
      html += `<tr><td>${r.key}</td><td>¥${fmtMoney(r.revenue)}</td><td>${r.orders}</td><td>${r.count}</td></tr>`;
    }
    html += `</tbody></table></div>`;
    cont.innerHTML = html;
  }

  function renderCompetitorDetail(byComp){
    const cont = document.getElementById('competitor_detail');
    let html = `<div class="table-responsive"><table class="table table-sm"><thead><tr><th>竞争方</th><th>营收 (¥)</th><th>订单数</th><th>记录数</th></tr></thead><tbody>`;
    for (let r of byComp){
      html += `<tr><td>${r.key}</td><td>¥${fmtMoney(r.revenue)}</td><td>${r.orders}</td><td>${r.count}</td></tr>`;
    }
    html += `</tbody></table></div>`;
    cont.innerHTML = html;
  }

  </script>
</body>
</html>
